"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _spinalEnvViewerGraphService = require("spinal-env-viewer-graph-service");

var _spinalModelsBuildingElements = require("spinal-models-building-elements");

var _constants = require("./constants");

var constants = _interopRequireWildcard(_constants);

var _spinalCoreConnectorjs_type = require("spinal-core-connectorjs_type");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

// import bimobjService from 'spinal-env-viewer-plugin-bimobjectservice';

const bimobjService = window.spinal.BimObjectService;

const GeographicContext = {
  constants: constants,

  /**
   * Returns the child type of the type given as parameter.
   * @param {string} parentType
   * @return {string} Child type
   */
  getChildType(parentType) {
    let parentTypeIndex = constants.GEOGRAPHIC_TYPES_ORDER.indexOf(parentType);

    if (parentTypeIndex === -1) {
      return "";
    }

    return constants.GEOGRAPHIC_TYPES_ORDER[parentTypeIndex + 1];
  },

  /**
   * It Takes as parameter a context name, returns true if a context with the same name does not exist, else returns false.
   * @param {string} contextName
   * @returns {Boolean}
   */
  createContext(contextName) {
    if (typeof contextName !== "string") {
      throw Error("contextName must be a string");
    }

    const context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(contextName);

    if (typeof context !== "undefined") return context;

    return _spinalEnvViewerGraphService.SpinalGraphService.addContext(contextName, constants.CONTEXT_TYPE, new _spinalModelsBuildingElements.AbstractElement(contextName));
  },

  /**
   * This method takes as parameters a context (SpinalContext), a parent node (must be a SpinalNode) and a string representing the abstract element type;
   * @param {SpinalContext} context - The Context geographic
   * @param {SpinalNode} node - The parent Node
   * @param {string} elementName - The AbstactElement Name
   * @returns {Boolean}
   */
  addAbstractElement(context, node, elementName) {
    const parentType = node.type.get();
    const childType = this.getChildType(parentType);

    if (!childType) {
      throw Error(`${parentType} is not a valid type in geographic context`);
    }

    const childRelation = constants.MAP_TYPE_RELATION.get(childType);

    const childNode = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: elementName,
      type: childType
    }, new _spinalModelsBuildingElements.AbstractElement(elementName));
    _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(node.id.get(), childNode, context.id.get(), childRelation, _spinalEnvViewerGraphService.SPINAL_RELATION_TYPE);

    this.addToReferenceContext(childNode);

    return true;
  },

  /**
   * @param {string} contextId - The Context geographic Id
   * @param {string} parentId - The parent Node Id
   * @param {string} buildingName - Building Name
   */
  addBuilding(contextId, parentId, buildingName) {

    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: buildingName,
      type: constants.BUILDING_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(buildingName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.BUILDING_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_TYPE);
  },

  /**
   * @param {string} contextId - The Context geographic Id
   * @param {string} parentId - The parent Node Id
   * @param {string} floorName - the floor Name
   */
  addFloor(contextId, parentId, floorName) {

    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: floorName,
      type: constants.FLOOR_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(floorName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.FLOOR_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_TYPE);
  },

  /**
   * @param {string} contextId - The Context geographic Id
   * @param {string} parentId - The parent Node Id
   * @param {string} siteName - the site Name
   */
  addSite(contextId, parentId, siteName) {

    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: siteName,
      type: constants.SITE_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(siteName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.SITE_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_TYPE);
  },

  /**
   * @param {string} contextId - The Context geographic Id
   * @param {string} parentId - The parent Node Id
   * @param {string} zoneName - Zone name
   */
  addZone(contextId, parentId, zoneName) {
    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: zoneName,
      type: constants.ZONE_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(zoneName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.ZONE_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_TYPE);
  },

  /**
   * @param {string} contextId - The Context geographic
   * @param {string} parentId - The parent Node
   * @param {string} roomName - Room Name
   */
  addRoom(contextId, parentId, roomName) {
    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: roomName,
      type: constants.ROOM_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(roomName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.ROOM_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_TYPE);
  },

  /**
   * it uses bimObject service to add all dbIds passed as parameters.
   * the parameter dbIds can be a simple dbIds or a list of dbIds.
   * @param {SpinalContext} context - The Context geographic
   * @param {SpinalNode} node - The parent Node
   * @param {Number | Array<Number>} dbIds - Can be
   */
  addBimElement(context, node, dbIds, model) {

    if (!Array.isArray(dbIds)) dbIds = [dbIds];

    // le bimObjectService
    // let c = SpinalGraphService.getRealNode(context.id.get());
    // let n = SpinalGraphService.getRealNode(node.id.get());

    let contextId = context.id.get();
    let parentId = node.id.get();

    dbIds.forEach(element => {
      // bimobjService.addBIMObject(c, n, element.dbId, element.name);
      window.spinal.BimObjectService.addBIMObject(contextId, parentId, element.dbId, element.name, model);
    });
  },

  _getReferenceContextName(nodeId) {
    let node = _spinalEnvViewerGraphService.SpinalGraphService.getInfo(nodeId);

    switch (node.type.get()) {
      case constants.SITE_TYPE:
        return {
          name: constants.SITE_REFERENCE_CONTEXT,
          relation: constants.SITE_RELATION
        };
      case constants.BUILDING_TYPE:
        return {
          name: constants.BUILDING_REFERENCE_CONTEXT,
          relation: constants.BUILDING_RELATION
        };

      case constants.FLOOR_TYPE:
        return {
          name: constants.FLOOR_REFERENCE_CONTEXT,
          relation: constants.FLOOR_RELATION
        };

      case constants.ZONE_TYPE:
        return {
          name: constants.ZONE_REFERENCE_CONTEXT,
          relation: constants.ZONE_RELATION
        };

      case constants.ROOM_TYPE:
        return {
          name: constants.ROOM_REFERENCE_CONTEXT,
          relation: constants.ROOM_RELATION
        };

      default:
        return undefined;
    }
  },

  /**
   *
   * @param {string} nodeId
   */
  addToReferenceContext(nodeId) {
    let obj = this._getReferenceContextName(nodeId);

    if (typeof obj !== "undefined") {
      let context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(obj.name);

      if (typeof context !== "undefined") {

        return _spinalEnvViewerGraphService.SpinalGraphService.addChild(context.info.id.get(), nodeId, obj.relation, _spinalEnvViewerGraphService.SPINAL_RELATION_LST_PTR_TYPE);
      }

      return _spinalEnvViewerGraphService.SpinalGraphService.addContext(obj.name, obj.name.replace(".", ""), new _spinalCoreConnectorjs_type.Model({
        name: obj.name
      })).then(c => {
        return _spinalEnvViewerGraphService.SpinalGraphService.addChild(c.info.id.get(), nodeId, obj.relation, _spinalEnvViewerGraphService.SPINAL_RELATION_LST_PTR_TYPE);
      });
    }
  },

  /**
   *
   * @param {string} contextId
   */
  addContextToReference(contextId) {
    let context = _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(contextId);

    if (typeof context !== "undefined") {
      return context.forEach(constants.GEOGRAPHIC_RELATIONS, node => {
        _spinalEnvViewerGraphService.SpinalGraphService._addNode(node);
        this.addToReferenceContext(node.info.id.get());
      });
    }
  }

};

exports.default = GeographicContext;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJjb25zdGFudHMiLCJiaW1vYmpTZXJ2aWNlIiwid2luZG93Iiwic3BpbmFsIiwiQmltT2JqZWN0U2VydmljZSIsIkdlb2dyYXBoaWNDb250ZXh0IiwiZ2V0Q2hpbGRUeXBlIiwicGFyZW50VHlwZSIsInBhcmVudFR5cGVJbmRleCIsIkdFT0dSQVBISUNfVFlQRVNfT1JERVIiLCJpbmRleE9mIiwiY3JlYXRlQ29udGV4dCIsImNvbnRleHROYW1lIiwiRXJyb3IiLCJjb250ZXh0IiwiU3BpbmFsR3JhcGhTZXJ2aWNlIiwiZ2V0Q29udGV4dCIsImFkZENvbnRleHQiLCJDT05URVhUX1RZUEUiLCJBYnN0cmFjdEVsZW1lbnQiLCJhZGRBYnN0cmFjdEVsZW1lbnQiLCJub2RlIiwiZWxlbWVudE5hbWUiLCJ0eXBlIiwiZ2V0IiwiY2hpbGRUeXBlIiwiY2hpbGRSZWxhdGlvbiIsIk1BUF9UWVBFX1JFTEFUSU9OIiwiY2hpbGROb2RlIiwiY3JlYXRlTm9kZSIsIm5hbWUiLCJhZGRDaGlsZEluQ29udGV4dCIsImlkIiwiU1BJTkFMX1JFTEFUSU9OX1RZUEUiLCJhZGRUb1JlZmVyZW5jZUNvbnRleHQiLCJhZGRCdWlsZGluZyIsImNvbnRleHRJZCIsInBhcmVudElkIiwiYnVpbGRpbmdOYW1lIiwibm9kZUlkIiwiQlVJTERJTkdfVFlQRSIsIkJVSUxESU5HX1JFTEFUSU9OIiwiYWRkRmxvb3IiLCJmbG9vck5hbWUiLCJGTE9PUl9UWVBFIiwiRkxPT1JfUkVMQVRJT04iLCJhZGRTaXRlIiwic2l0ZU5hbWUiLCJTSVRFX1RZUEUiLCJTSVRFX1JFTEFUSU9OIiwiYWRkWm9uZSIsInpvbmVOYW1lIiwiWk9ORV9UWVBFIiwiWk9ORV9SRUxBVElPTiIsImFkZFJvb20iLCJyb29tTmFtZSIsIlJPT01fVFlQRSIsIlJPT01fUkVMQVRJT04iLCJhZGRCaW1FbGVtZW50IiwiZGJJZHMiLCJtb2RlbCIsIkFycmF5IiwiaXNBcnJheSIsImZvckVhY2giLCJlbGVtZW50IiwiYWRkQklNT2JqZWN0IiwiZGJJZCIsIl9nZXRSZWZlcmVuY2VDb250ZXh0TmFtZSIsImdldEluZm8iLCJTSVRFX1JFRkVSRU5DRV9DT05URVhUIiwicmVsYXRpb24iLCJCVUlMRElOR19SRUZFUkVOQ0VfQ09OVEVYVCIsIkZMT09SX1JFRkVSRU5DRV9DT05URVhUIiwiWk9ORV9SRUZFUkVOQ0VfQ09OVEVYVCIsIlJPT01fUkVGRVJFTkNFX0NPTlRFWFQiLCJ1bmRlZmluZWQiLCJvYmoiLCJhZGRDaGlsZCIsImluZm8iLCJTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFIiwicmVwbGFjZSIsIk1vZGVsIiwidGhlbiIsImMiLCJhZGRDb250ZXh0VG9SZWZlcmVuY2UiLCJnZXRSZWFsTm9kZSIsIkdFT0dSQVBISUNfUkVMQVRJT05TIiwiX2FkZE5vZGUiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOztBQUtBOztBQVFBOztJQUFZQSxTOztBQUNaOzs7O0FBTEE7O0FBRUEsTUFBTUMsZ0JBQWdCQyxPQUFPQyxNQUFQLENBQWNDLGdCQUFwQzs7QUFPQSxNQUFNQyxvQkFBb0I7QUFDeEJMLGFBQVdBLFNBRGE7O0FBR3hCOzs7OztBQUtBTSxlQUFhQyxVQUFiLEVBQXlCO0FBQ3ZCLFFBQUlDLGtCQUFrQlIsVUFBVVMsc0JBQVYsQ0FBaUNDLE9BQWpDLENBQ3BCSCxVQURvQixDQUF0Qjs7QUFHQSxRQUFJQyxvQkFBb0IsQ0FBQyxDQUF6QixFQUE0QjtBQUMxQixhQUFPLEVBQVA7QUFDRDs7QUFFRCxXQUFPUixVQUFVUyxzQkFBVixDQUFpQ0Qsa0JBQWtCLENBQW5ELENBQVA7QUFDRCxHQWpCdUI7O0FBbUJ4Qjs7Ozs7QUFLQUcsZ0JBQWNDLFdBQWQsRUFBMkI7QUFDekIsUUFBSSxPQUFPQSxXQUFQLEtBQXVCLFFBQTNCLEVBQXFDO0FBQ25DLFlBQU1DLE1BQ0osOEJBREksQ0FBTjtBQUVEOztBQUVELFVBQU1DLFVBQVVDLGdEQUFtQkMsVUFBbkIsQ0FBOEJKLFdBQTlCLENB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RE4sd0RBQW1Cd0UsUUFBbkIsQ0FBNEJsRSxJQUE1QjtBQUNBLGFBQUthLHFCQUFMLENBQTJCYixLQUFLeUQsSUFBTCxDQUFVOUMsRUFBVixDQUFhUixHQUFiLEVBQTNCO0FBQ0QsT0FITSxDQUFQO0FBSUQ7QUFFRjs7QUE5UnVCLENBQTFCOztrQkFrU2VuQixpQiIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFNQSU5BTF9SRUxBVElPTl9UWVBFLFxuICBTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFLFxuICBTcGluYWxHcmFwaFNlcnZpY2Vcbn0gZnJvbSBcInNwaW5hbC1lbnYtdmlld2VyLWdyYXBoLXNlcnZpY2VcIjtcbmltcG9ydCB7XG4gIEFic3RyYWN0RWxlbWVudFxufSBmcm9tIFwic3BpbmFsLW1vZGVscy1idWlsZGluZy1lbGVtZW50c1wiO1xuXG4vLyBpbXBvcnQgYmltb2JqU2VydmljZSBmcm9tICdzcGluYWwtZW52LXZpZXdlci1wbHVnaW4tYmltb2JqZWN0c2VydmljZSc7XG5cbmNvbnN0IGJpbW9ialNlcnZpY2UgPSB3aW5kb3cuc3BpbmFsLkJpbU9iamVjdFNlcnZpY2U7XG5cbmltcG9ydCAqIGFzIGNvbnN0YW50cyBmcm9tIFwiLi9jb25zdGFudHNcIjtcbmltcG9ydCB7XG4gIE1vZGVsXG59IGZyb20gXCJzcGluYWwtY29yZS1jb25uZWN0b3Jqc190eXBlXCI7XG5cbmNvbnN0IEdlb2dyYXBoaWNDb250ZXh0ID0ge1xuICBjb25zdGFudHM6IGNvbnN0YW50cyxcblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgY2hpbGQgdHlwZSBvZiB0aGUgdHlwZSBnaXZlbiBhcyBwYXJhbWV0ZXIuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXJlbnRUeXBlXG4gICAqIEByZXR1cm4ge3N0cmluZ30gQ2hpbGQgdHlwZVxuICAgKi9cbiAgZ2V0Q2hpbGRUeXBlKHBhcmVudFR5cGUpIHtcbiAgICBsZXQgcGFyZW50VHlwZUluZGV4ID0gY29uc3RhbnRzLkdFT0dSQVBISUNfVFlQRVNfT1JERVIuaW5kZXhPZihcbiAgICAgIHBhcmVudFR5cGUpO1xuXG4gICAgaWYgKHBhcmVudFR5cGVJbmRleCA9PT0gLTEpIHtcbiAgICAgIHJldHVybiBcIlwiO1xuICAgIH1cblxuICAgIHJldHVybiBjb25zdGFudHMuR0VPR1JBUEhJQ19UWVBFU19PUkRFUltwYXJlbnRUeXBlSW5kZXggKyAxXTtcbiAgfSxcblxuICAvKipcbiAgICogSXQgVGFrZXMgYXMgcGFyYW1ldGVyIGEgY29udGV4dCBuYW1lLCByZXR1cm5zIHRydWUgaWYgYSBjb250ZXh0IHdpdGggdGhlIHNhbWUgbmFtZSBkb2VzIG5vdCBleGlzdCwgZWxzZSByZXR1cm5zIGZhbHNlLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY29udGV4dE5hbWVcbiAgICogQHJldHVybnMge0Jvb2xlYW59XG4gICAqL1xuICBjcmVhdGVDb250ZXh0KGNvbnRleHROYW1lKSB7XG4gICAgaWYgKHR5cGVvZiBjb250ZXh0TmFtZSAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgIFwiY29udGV4dE5hbWUgbXVzdCBiZSBhIHN0cmluZ1wiKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb250ZXh0ID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldENvbnRleHQoY29udGV4dE5hbWUpO1xuXG4gICAgaWYgKHR5cGVvZiBjb250ZXh0ICE9PSBcInVuZGVmaW5lZFwiKSByZXR1cm4gY29udGV4dDtcblxuXG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDb250ZXh0KGNvbnRleHROYW1lLFxuICAgICAgY29uc3RhbnRzLkNPTlRFWFRfVFlQRSxcbiAgICAgIG5ldyBBYnN0cmFjdEVsZW1lbnQoY29udGV4dE5hbWUpKTtcblxuXG4gIH0sXG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIHRha2VzIGFzIHBhcmFtZXRlcnMgYSBjb250ZXh0IChTcGluYWxDb250ZXh0KSwgYSBwYXJlbnQgbm9kZSAobXVzdCBiZSBhIFNwaW5hbE5vZGUpIGFuZCBhIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGFic3RyYWN0IGVsZW1lbnQgdHlwZTtcbiAgICogQHBhcmFtIHtTcGluYWxDb250ZXh0fSBjb250ZXh0IC0gVGhlIENvbnRleHQgZ2VvZ3JhcGhpY1xuICAgKiBAcGFyYW0ge1NwaW5hbE5vZGV9IG5vZGUgLSBUaGUgcGFyZW50IE5vZGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IGVsZW1lbnROYW1lIC0gVGhlIEFic3RhY3RFbGVtZW50IE5hbWVcbiAgICogQHJldHVybnMge0Jvb2xlYW59XG4gICAqL1xuICBhZGRBYnN0cmFjdEVsZW1lbnQoY29udGV4dCwgbm9kZSwgZWxlbWVudE5hbWUpIHtcbiAgICBjb25zdCBwYXJlbnRUeXBlID0gbm9kZS50eXBlLmdldCgpO1xuICAgIGNvbnN0IGNoaWxkVHlwZSA9IHRoaXMuZ2V0Q2hpbGRUeXBlKHBhcmVudFR5cGUpO1xuXG4gICAgaWYgKCFjaGlsZFR5cGUpIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICBgJHtwYXJlbnRUeXBlfSBpcyBub3QgYSB2YWxpZCB0eXBlIGluIGdlb2dyYXBoaWMgY29udGV4dGBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgY2hpbGRSZWxhdGlvbiA9IGNvbnN0YW50cy5NQVBfVFlQRV9SRUxBVElPTi5nZXQoY2hpbGRUeXBlKTtcblxuICAgIGNvbnN0IGNoaWxkTm9kZSA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgICAgbmFtZTogZWxlbWVudE5hbWUsXG4gICAgICAgIHR5cGU6IGNoaWxkVHlwZVxuICAgICAgfSxcbiAgICAgIG5ldyBBYnN0cmFjdEVsZW1lbnQoZWxlbWVudE5hbWUpXG4gICAgKTtcbiAgICBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGRJbkNvbnRleHQobm9kZS5pZC5nZXQoKSwgY2hpbGROb2RlLCBjb250ZXh0LmlkXG4gICAgICAuZ2V0KCksIGNoaWxkUmVsYXRpb24sIFNQSU5BTF9SRUxBVElPTl9UWVBFKTtcblxuICAgIHRoaXMuYWRkVG9SZWZlcmVuY2VDb250ZXh0KGNoaWxkTm9kZSk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSxcblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbnRleHRJZCAtIFRoZSBDb250ZXh0IGdlb2dyYXBoaWMgSWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhcmVudElkIC0gVGhlIHBhcmVudCBOb2RlIElkXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBidWlsZGluZ05hbWUgLSBCdWlsZGluZyBOYW1lXG4gICAqL1xuICBhZGRCdWlsZGluZyhjb250ZXh0SWQsIHBhcmVudElkLCBidWlsZGluZ05hbWUpIHtcblxuICAgIGxldCBub2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICBuYW1lOiBidWlsZGluZ05hbWUsXG4gICAgICB0eXBlOiBjb25zdGFudHMuQlVJTERJTkdfVFlQRVxuICAgIH0sIG5ldyBBYnN0cmFjdEVsZW1lbnQoYnVpbGRpbmdOYW1lKSk7XG5cbiAgICB0aGlzLmFkZFRvUmVmZXJlbmNlQ29udGV4dChub2RlSWQpO1xuXG5cbiAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkSW5Db250ZXh0KHBhcmVudElkLCBub2RlSWQsIGNvbnRleHRJZCxcbiAgICAgIGNvbnN0YW50cy5CVUlMRElOR19SRUxBVElPTiwgU1BJTkFMX1JFTEFUSU9OX1RZUEUpXG5cbiAgfSxcblxuXG5cblxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY29udGV4dElkIC0gVGhlIENvbnRleHQgZ2VvZ3JhcGhpYyBJZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGFyZW50SWQgLSBUaGUgcGFyZW50IE5vZGUgSWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IGZsb29yTmFtZSAtIHRoZSBmbG9vciBOYW1lXG4gICAqL1xuICBhZGRGbG9vcihjb250ZXh0SWQsIHBhcmVudElkLCBmbG9vck5hbWUpIHtcblxuICAgIGxldCBub2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICBuYW1lOiBmbG9vck5hbWUsXG4gICAgICB0eXBlOiBjb25zdGFudHMuRkxPT1JfVFlQRVxuICAgIH0sIG5ldyBBYnN0cmFjdEVsZW1lbnQoZmxvb3JOYW1lKSk7XG5cbiAgICB0aGlzLmFkZFRvUmVmZXJlbmNlQ29udGV4dChub2RlSWQpO1xuXG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZEluQ29udGV4dChwYXJlbnRJZCwgbm9kZUlkLCBjb250ZXh0SWQsXG4gICAgICBjb25zdGFudHMuRkxPT1JfUkVMQVRJT04sIFNQSU5BTF9SRUxBVElPTl9UWVBFKVxuXG4gIH0sXG5cblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbnRleHRJZCAtIFRoZSBDb250ZXh0IGdlb2dyYXBoaWMgSWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhcmVudElkIC0gVGhlIHBhcmVudCBOb2RlIElkXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzaXRlTmFtZSAtIHRoZSBzaXRlIE5hbWVcbiAgICovXG4gIGFkZFNpdGUoY29udGV4dElkLCBwYXJlbnRJZCwgc2l0ZU5hbWUpIHtcblxuICAgIGxldCBub2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICBuYW1lOiBzaXRlTmFtZSxcbiAgICAgIHR5cGU6IGNvbnN0YW50cy5TSVRFX1RZUEVcbiAgICB9LCBuZXcgQWJzdHJhY3RFbGVtZW50KHNpdGVOYW1lKSk7XG5cbiAgICB0aGlzLmFkZFRvUmVmZXJlbmNlQ29udGV4dChub2RlSWQpO1xuXG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZEluQ29udGV4dChwYXJlbnRJZCwgbm9kZUlkLCBjb250ZXh0SWQsXG4gICAgICBjb25zdGFudHMuU0lURV9SRUxBVElPTiwgU1BJTkFMX1JFTEFUSU9OX1RZUEUpXG5cbiAgfSxcblxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY29udGV4dElkIC0gVGhlIENvbnRleHQgZ2VvZ3JhcGhpYyBJZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGFyZW50SWQgLSBUaGUgcGFyZW50IE5vZGUgSWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHpvbmVOYW1lIC0gWm9uZSBuYW1lXG4gICAqL1xuICBhZGRab25lKGNvbnRleHRJZCwgcGFyZW50SWQsIHpvbmVOYW1lKSB7XG4gICAgbGV0IG5vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgIG5hbWU6IHpvbmVOYW1lLFxuICAgICAgdHlwZTogY29uc3RhbnRzLlpPTkVfVFlQRVxuICAgIH0sIG5ldyBBYnN0cmFjdEVsZW1lbnQoem9uZU5hbWUpKTtcblxuICAgIHRoaXMuYWRkVG9SZWZlcmVuY2VDb250ZXh0KG5vZGVJZCk7XG5cbiAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkSW5Db250ZXh0KHBhcmVudElkLCBub2RlSWQsIGNvbnRleHRJZCxcbiAgICAgIGNvbnN0YW50cy5aT05FX1JFTEFUSU9OLCBTUElOQUxfUkVMQVRJT05fVFlQRSk7XG5cbiAgfSxcblxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY29udGV4dElkIC0gVGhlIENvbnRleHQgZ2VvZ3JhcGhpY1xuICAgKiBAcGFyYW0ge3N0cmluZ30gcGFyZW50SWQgLSBUaGUgcGFyZW50IE5vZGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHJvb21OYW1lIC0gUm9vbSBOYW1lXG4gICAqL1xuICBhZGRSb29tKGNvbnRleHRJZCwgcGFyZW50SWQsIHJvb21OYW1lKSB7XG4gICAgbGV0IG5vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgIG5hbWU6IHJvb21OYW1lLFxuICAgICAgdHlwZTogY29uc3RhbnRzLlJPT01fVFlQRVxuICAgIH0sIG5ldyBBYnN0cmFjdEVsZW1lbnQocm9vbU5hbWUpKTtcblxuICAgIHRoaXMuYWRkVG9SZWZlcmVuY2VDb250ZXh0KG5vZGVJZCk7XG5cbiAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkSW5Db250ZXh0KHBhcmVudElkLCBub2RlSWQsIGNvbnRleHRJZCxcbiAgICAgIGNvbnN0YW50cy5ST09NX1JFTEFUSU9OLCBTUElOQUxfUkVMQVRJT05fVFlQRSk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIGl0IHVzZXMgYmltT2JqZWN0IHNlcnZpY2UgdG8gYWRkIGFsbCBkYklkcyBwYXNzZWQgYXMgcGFyYW1ldGVycy5cbiAgICogdGhlIHBhcmFtZXRlciBkYklkcyBjYW4gYmUgYSBzaW1wbGUgZGJJZHMgb3IgYSBsaXN0IG9mIGRiSWRzLlxuICAgKiBAcGFyYW0ge1NwaW5hbENvbnRleHR9IGNvbnRleHQgLSBUaGUgQ29udGV4dCBnZW9ncmFwaGljXG4gICAqIEBwYXJhbSB7U3BpbmFsTm9kZX0gbm9kZSAtIFRoZSBwYXJlbnQgTm9kZVxuICAgKiBAcGFyYW0ge051bWJlciB8IEFycmF5PE51bWJlcj59IGRiSWRzIC0gQ2FuIGJlXG4gICAqL1xuICBhZGRCaW1FbGVtZW50KGNvbnRleHQsIG5vZGUsIGRiSWRzLCBtb2RlbCkge1xuXG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGRiSWRzKSkgZGJJZHMgPSBbZGJJZHNdO1xuXG5cbiAgICAvLyBsZSBiaW1PYmplY3RTZXJ2aWNlXG4gICAgLy8gbGV0IGMgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0UmVhbE5vZGUoY29udGV4dC5pZC5nZXQoKSk7XG4gICAgLy8gbGV0IG4gPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0UmVhbE5vZGUobm9kZS5pZC5nZXQoKSk7XG5cbiAgICBsZXQgY29udGV4dElkID0gY29udGV4dC5pZC5nZXQoKTtcbiAgICBsZXQgcGFyZW50SWQgPSBub2RlLmlkLmdldCgpO1xuXG4gICAgZGJJZHMuZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgIC8vIGJpbW9ialNlcnZpY2UuYWRkQklNT2JqZWN0KGMsIG4sIGVsZW1lbnQuZGJJZCwgZWxlbWVudC5uYW1lKTtcbiAgICAgIHdpbmRvdy5zcGluYWwuQmltT2JqZWN0U2VydmljZS5hZGRCSU1PYmplY3QoY29udGV4dElkLCBwYXJlbnRJZCxcbiAgICAgICAgZWxlbWVudC5kYklkLFxuICAgICAgICBlbGVtZW50Lm5hbWUsIG1vZGVsKVxuICAgIH0pO1xuICB9LFxuXG5cbiAgX2dldFJlZmVyZW5jZUNvbnRleHROYW1lKG5vZGVJZCkge1xuICAgIGxldCBub2RlID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldEluZm8obm9kZUlkKTtcblxuICAgIHN3aXRjaCAobm9kZS50eXBlLmdldCgpKSB7XG4gICAgICBjYXNlIGNvbnN0YW50cy5TSVRFX1RZUEU6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogY29uc3RhbnRzLlNJVEVfUkVGRVJFTkNFX0NPTlRFWFQsXG4gICAgICAgICAgICByZWxhdGlvbjogY29uc3RhbnRzLlNJVEVfUkVMQVRJT05cbiAgICAgICAgfTtcbiAgICAgIGNhc2UgY29uc3RhbnRzLkJVSUxESU5HX1RZUEU6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogY29uc3RhbnRzLkJVSUxESU5HX1JFRkVSRU5DRV9DT05URVhULFxuICAgICAgICAgICAgcmVsYXRpb246IGNvbnN0YW50cy5CVUlMRElOR19SRUxBVElPTlxuICAgICAgICB9O1xuXG4gICAgICBjYXNlIGNvbnN0YW50cy5GTE9PUl9UWVBFOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IGNvbnN0YW50cy5GTE9PUl9SRUZFUkVOQ0VfQ09OVEVYVCxcbiAgICAgICAgICAgIHJlbGF0aW9uOiBjb25zdGFudHMuRkxPT1JfUkVMQVRJT05cbiAgICAgICAgfTtcblxuICAgICAgY2FzZSBjb25zdGFudHMuWk9ORV9UWVBFOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IGNvbnN0YW50cy5aT05FX1JFRkVSRU5DRV9DT05URVhULFxuICAgICAgICAgICAgcmVsYXRpb246IGNvbnN0YW50cy5aT05FX1JFTEFUSU9OXG4gICAgICAgIH07XG5cbiAgICAgIGNhc2UgY29uc3RhbnRzLlJPT01fVFlQRTpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiBjb25zdGFudHMuUk9PTV9SRUZFUkVOQ0VfQ09OVEVYVCxcbiAgICAgICAgICAgIHJlbGF0aW9uOiBjb25zdGFudHMuUk9PTV9SRUxBVElPTlxuICAgICAgICB9O1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IG5vZGVJZFxuICAgKi9cbiAgYWRkVG9SZWZlcmVuY2VDb250ZXh0KG5vZGVJZCkge1xuICAgIGxldCBvYmogPSB0aGlzLl9nZXRSZWZlcmVuY2VDb250ZXh0TmFtZShub2RlSWQpO1xuXG4gICAgaWYgKHR5cGVvZiBvYmogIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIGxldCBjb250ZXh0ID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldENvbnRleHQob2JqLm5hbWUpO1xuXG4gICAgICBpZiAodHlwZW9mIGNvbnRleHQgIT09IFwidW5kZWZpbmVkXCIpIHtcblxuICAgICAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkKGNvbnRleHQuaW5mby5pZC5nZXQoKSwgbm9kZUlkLFxuICAgICAgICAgIG9iai5yZWxhdGlvbixcbiAgICAgICAgICBTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDb250ZXh0KG9iai5uYW1lLCBvYmoubmFtZS5yZXBsYWNlKFxuICAgICAgICBcIi5cIiwgXCJcIiksIG5ldyBNb2RlbCh7XG4gICAgICAgIG5hbWU6IG9iai5uYW1lXG4gICAgICB9KSkudGhlbihjID0+IHtcbiAgICAgICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZChjLmluZm8uaWQuZ2V0KCksIG5vZGVJZCxcbiAgICAgICAgICBvYmoucmVsYXRpb24sXG4gICAgICAgICAgU1BJTkFMX1JFTEFUSU9OX0xTVF9QVFJfVFlQRSk7XG4gICAgICB9KTtcblxuXG4gICAgfVxuXG4gIH0sXG5cbiAgLyoqXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb250ZXh0SWRcbiAgICovXG4gIGFkZENvbnRleHRUb1JlZmVyZW5jZShjb250ZXh0SWQpIHtcbiAgICBsZXQgY29udGV4dCA9IFNwaW5hbEdyYXBoU2VydmljZS5nZXRSZWFsTm9kZShjb250ZXh0SWQpO1xuXG4gICAgaWYgKHR5cGVvZiBjb250ZXh0ICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICByZXR1cm4gY29udGV4dC5mb3JFYWNoKGNvbnN0YW50cy5HRU9HUkFQSElDX1JFTEFUSU9OUywgKG5vZGUpID0+IHtcbiAgICAgICAgU3BpbmFsR3JhcGhTZXJ2aWNlLl9hZGROb2RlKG5vZGUpO1xuICAgICAgICB0aGlzLmFkZFRvUmVmZXJlbmNlQ29udGV4dChub2RlLmluZm8uaWQuZ2V0KCkpO1xuICAgICAgfSlcbiAgICB9XG5cbiAgfVxuXG59O1xuXG5leHBvcnQgZGVmYXVsdCBHZW9ncmFwaGljQ29udGV4dDsiXX0=