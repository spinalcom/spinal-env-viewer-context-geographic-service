"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _spinalEnvViewerGraphService = require("spinal-env-viewer-graph-service");

var _spinalModelsBuildingElements = require("spinal-models-building-elements");

var _constants = require("./constants");

var constants = _interopRequireWildcard(_constants);

var _spinalCoreConnectorjs_type = require("spinal-core-connectorjs_type");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

// import bimobjService from 'spinal-env-viewer-plugin-bimobjectservice';

const bimobjService = window.spinal.BimObjectService;

const GeographicContext = {
  constants: constants,

  /**
   * Returns the child type of the type given as parameter.
   * @param {string} parentType
   * @return {string} Child type
   */
  getChildType(parentType) {
    let parentTypeIndex = constants.GEOGRAPHIC_TYPES_ORDER.indexOf(parentType);

    if (parentTypeIndex === -1) {
      return "";
    }

    return constants.GEOGRAPHIC_TYPES_ORDER[parentTypeIndex + 1];
  },

  /**
   * It Takes as parameter a context name, returns true if a context with the same name does not exist, else returns false.
   * @param {string} contextName
   * @returns {Boolean}
   */
  createContext(contextName) {
    if (typeof contextName !== "string") {
      throw Error("contextName must be a string");
    }

    const context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(contextName);

    if (typeof context !== "undefined") return Promise.resolve(context);

    return _spinalEnvViewerGraphService.SpinalGraphService.addContext(contextName, constants.CONTEXT_TYPE, new _spinalModelsBuildingElements.AbstractElement(contextName));
  },

  /**
   * This method takes as parameters a context (SpinalContext), a parent node (must be a SpinalNode) and a string representing the abstract element type;
   * @param {SpinalContext} context - The Context geographic
   * @param {SpinalNode} node - The parent Node
   * @param {string} elementName - The AbstactElement Name
   * @returns {Boolean}
   */
  addAbstractElement(context, node, elementName) {
    const parentType = node.type.get();
    const childType = this.getChildType(parentType);

    if (!childType) {
      throw Error(`${parentType} is not a valid type in geographic context`);
    }

    const childRelation = constants.MAP_TYPE_RELATION.get(childType);

    const childNode = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: elementName,
      type: childType
    }, new _spinalModelsBuildingElements.AbstractElement(elementName));
    _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(node.id.get(), childNode, context.id.get(), childRelation, _spinalEnvViewerGraphService.SPINAL_RELATION_TYPE);

    this.addToReferenceContext(childNode);

    return true;
  },

  /**
   * @param {string} contextId - The Context geographic Id
   * @param {string} parentId - The parent Node Id
   * @param {string} buildingName - Building Name
   */
  addBuilding(contextId, parentId, buildingName) {

    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: buildingName,
      type: constants.BUILDING_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(buildingName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.BUILDING_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_TYPE);
  },

  /**
   * @param {string} contextId - The Context geographic Id
   * @param {string} parentId - The parent Node Id
   * @param {string} floorName - the floor Name
   */
  addFloor(contextId, parentId, floorName) {

    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: floorName,
      type: constants.FLOOR_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(floorName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.FLOOR_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_TYPE);
  },

  /**
   * @param {string} contextId - The Context geographic Id
   * @param {string} parentId - The parent Node Id
   * @param {string} siteName - the site Name
   */
  addSite(contextId, parentId, siteName) {

    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: siteName,
      type: constants.SITE_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(siteName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.SITE_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_TYPE);
  },

  /**
   * @param {string} contextId - The Context geographic Id
   * @param {string} parentId - The parent Node Id
   * @param {string} zoneName - Zone name
   */
  addZone(contextId, parentId, zoneName) {
    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: zoneName,
      type: constants.ZONE_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(zoneName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.ZONE_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_TYPE);
  },

  /**
   * @param {string} contextId - The Context geographic
   * @param {string} parentId - The parent Node
   * @param {string} roomName - Room Name
   */
  addRoom(contextId, parentId, roomName) {
    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: roomName,
      type: constants.ROOM_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(roomName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.ROOM_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_TYPE);
  },

  /**
   * it uses bimObject service to add all dbIds passed as parameters.
   * the parameter dbIds can be a simple dbIds or a list of dbIds.
   * @param {SpinalContext} context - The Context geographic
   * @param {SpinalNode} node - The parent Node
   * @param {Number | Array<Number>} dbIds - Can be
   */
  addBimElement(context, node, dbIds, model) {

    if (!Array.isArray(dbIds)) dbIds = [dbIds];

    // le bimObjectService
    // let c = SpinalGraphService.getRealNode(context.id.get());
    // let n = SpinalGraphService.getRealNode(node.id.get());

    let contextId = context.id.get();
    let parentId = node.id.get();

    dbIds.forEach(element => {
      // bimobjService.addBIMObject(c, n, element.dbId, element.name);
      window.spinal.BimObjectService.addBIMObject(contextId, parentId, element.dbId, element.name, model);
    });
  },

  _getReferenceContextName(nodeId) {
    let node = _spinalEnvViewerGraphService.SpinalGraphService.getInfo(nodeId);

    switch (node.type.get()) {
      case constants.SITE_TYPE:
        return {
          name: constants.SITE_REFERENCE_CONTEXT,
          relation: constants.SITE_RELATION
        };
      case constants.BUILDING_TYPE:
        return {
          name: constants.BUILDING_REFERENCE_CONTEXT,
          relation: constants.BUILDING_RELATION
        };

      case constants.FLOOR_TYPE:
        return {
          name: constants.FLOOR_REFERENCE_CONTEXT,
          relation: constants.FLOOR_RELATION
        };

      case constants.ZONE_TYPE:
        return {
          name: constants.ZONE_REFERENCE_CONTEXT,
          relation: constants.ZONE_RELATION
        };

      case constants.ROOM_TYPE:
        return {
          name: constants.ROOM_REFERENCE_CONTEXT,
          relation: constants.ROOM_RELATION
        };

      default:
        return undefined;
    }
  },

  /**
   *
   * @param {string} nodeId
   */
  addToReferenceContext(nodeId) {
    let obj = this._getReferenceContextName(nodeId);

    if (typeof obj !== "undefined") {
      let context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(obj.name);

      if (typeof context !== "undefined") {

        return _spinalEnvViewerGraphService.SpinalGraphService.addChild(context.info.id.get(), nodeId, obj.relation, _spinalEnvViewerGraphService.SPINAL_RELATION_LST_PTR_TYPE);
      }

      return _spinalEnvViewerGraphService.SpinalGraphService.addContext(obj.name, obj.name.replace(".", ""), new _spinalCoreConnectorjs_type.Model({
        name: obj.name
      })).then(c => {
        return _spinalEnvViewerGraphService.SpinalGraphService.addChild(c.info.id.get(), nodeId, obj.relation, _spinalEnvViewerGraphService.SPINAL_RELATION_LST_PTR_TYPE);
      });
    }
  },

  /**
   *
   * @param {string} contextId
   */
  addContextToReference(contextId) {
    let context = _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(contextId);

    if (typeof context !== "undefined") {
      return context.forEach(constants.GEOGRAPHIC_RELATIONS, node => {
        _spinalEnvViewerGraphService.SpinalGraphService._addNode(node);
        this.addToReferenceContext(node.info.id.get());
      });
    }
  }

};

exports.default = GeographicContext;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJjb25zdGFudHMiLCJiaW1vYmpTZXJ2aWNlIiwid2luZG93Iiwic3BpbmFsIiwiQmltT2JqZWN0U2VydmljZSIsIkdlb2dyYXBoaWNDb250ZXh0IiwiZ2V0Q2hpbGRUeXBlIiwicGFyZW50VHlwZSIsInBhcmVudFR5cGVJbmRleCIsIkdFT0dSQVBISUNfVFlQRVNfT1JERVIiLCJpbmRleE9mIiwiY3JlYXRlQ29udGV4dCIsImNvbnRleHROYW1lIiwiRXJyb3IiLCJjb250ZXh0IiwiU3BpbmFsR3JhcGhTZXJ2aWNlIiwiZ2V0Q29udGV4dCIsIlByb21pc2UiLCJyZXNvbHZlIiwiYWRkQ29udGV4dCIsIkNPTlRFWFRfVFlQRSIsIkFic3RyYWN0RWxlbWVudCIsImFkZEFic3RyYWN0RWxlbWVudCIsIm5vZGUiLCJlbGVtZW50TmFtZSIsInR5cGUiLCJnZXQiLCJjaGlsZFR5cGUiLCJjaGlsZFJlbGF0aW9uIiwiTUFQX1RZUEVfUkVMQVRJT04iLCJjaGlsZE5vZGUiLCJjcmVhdGVOb2RlIiwibmFtZSIsImFkZENoaWxkSW5Db250ZXh0IiwiaWQiLCJTUElOQUxfUkVMQVRJT05fVFlQRSIsImFkZFRvUmVmZXJlbmNlQ29udGV4dCIsImFkZEJ1aWxkaW5nIiwiY29udGV4dElkIiwicGFyZW50SWQiLCJidWlsZGluZ05hbWUiLCJub2RlSWQiLCJCVUlMRElOR19UWVBFIiwiQlVJTERJTkdfUkVMQVRJT04iLCJhZGRGbG9vciIsImZsb29yTmFtZSIsIkZMT09SX1RZUEUiLCJGTE9PUl9SRUxBVElPTiIsImFkZFNpdGUiLCJzaXRlTmFtZSIsIlNJVEVfVFlQRSIsIlNJVEVfUkVMQVRJT04iLCJhZGRab25lIiwiem9uZU5hbWUiLCJaT05FX1RZUEUiLCJaT05FX1JFTEFUSU9OIiwiYWRkUm9vbSIsInJvb21OYW1lIiwiUk9PTV9UWVBFIiwiUk9PTV9SRUxBVElPTiIsImFkZEJpbUVsZW1lbnQiLCJkYklkcyIsIm1vZGVsIiwiQXJyYXkiLCJpc0FycmF5IiwiZm9yRWFjaCIsImVsZW1lbnQiLCJhZGRCSU1PYmplY3QiLCJkYklkIiwiX2dldFJlZmVyZW5jZUNvbnRleHROYW1lIiwiZ2V0SW5mbyIsIlNJVEVfUkVGRVJFTkNFX0NPTlRFWFQiLCJyZWxhdGlvbiIsIkJVSUxESU5HX1JFRkVSRU5DRV9DT05URVhUIiwiRkxPT1JfUkVGRVJFTkNFX0NPTlRFWFQiLCJaT05FX1JFRkVSRU5DRV9DT05URVhUIiwiUk9PTV9SRUZFUkVOQ0VfQ09OVEVYVCIsInVuZGVmaW5lZCIsIm9iaiIsImFkZENoaWxkIiwiaW5mbyIsIlNQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEUiLCJyZXBsYWNlIiwiTW9kZWwiLCJ0aGVuIiwiYyIsImFkZENvbnRleHRUb1JlZmVyZW5jZSIsImdldFJlYWxOb2RlIiwiR0VPR1JBUEhJQ19SRUxBVElPTlMiLCJfYWRkTm9kZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBS0E7O0FBUUE7O0lBQVlBLFM7O0FBQ1o7Ozs7QUFMQTs7QUFFQSxNQUFNQyxnQkFBZ0JDLE9BQU9DLE1BQVAsQ0FBY0MsZ0JBQXBDOztBQU9BLE1BQU1DLG9CQUFvQjtBQUN4QkwsYUFBV0EsU0FEYTs7QUFHeEI7Ozs7O0FBS0FNLGVBQWFDLFVBQWIsRUFBeUI7QUFDdkIsUUFBSUMsa0JBQWtCUixVQUFVUyxzQkFBVixDQUFpQ0MsT0FBakMsQ0FDcEJILFVBRG9CLENBQXRCOztBQUdBLFFBQUlDLG9CQUFvQixDQUFDLENBQXpCLEVBQTRCO0FBQzFCLGFBQU8sRUFBUDtBQUNEOztBQUVELFdBQU9SLFVBQVVTLHNCQUFWLENBQWlDRCxrQkFBa0IsQ0FBbkQsQ0FBUDtBQUNELEdBakJ1Qjs7QUFtQnhCOzs7OztBQUtBRyxnQkFBY0MsV0FBZCxFQUEyQjtBQUN6QixRQUFJLE9BQU9BLFdBQVAsS0FBdUIsUUFBM0IsRUFBcUM7QUFDbkMsWUFBTUMsTUFDSiw4QkFESSxDQUFOO0FBRUQ7O0FBRUQsVUFBTUMsVUFBVUMsZ0RBQW1CQyxV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UW1ELE9BQVIsQ0FBZ0JqRSxVQUFVd0Ysb0JBQTFCLEVBQWlEakUsSUFBRCxJQUFVO0FBQy9EUix3REFBbUIwRSxRQUFuQixDQUE0QmxFLElBQTVCO0FBQ0EsYUFBS2EscUJBQUwsQ0FBMkJiLEtBQUt5RCxJQUFMLENBQVU5QyxFQUFWLENBQWFSLEdBQWIsRUFBM0I7QUFDRCxPQUhNLENBQVA7QUFJRDtBQUVGOztBQTlSdUIsQ0FBMUI7O2tCQWtTZXJCLGlCIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgU1BJTkFMX1JFTEFUSU9OX1RZUEUsXG4gIFNQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEUsXG4gIFNwaW5hbEdyYXBoU2VydmljZVxufSBmcm9tIFwic3BpbmFsLWVudi12aWV3ZXItZ3JhcGgtc2VydmljZVwiO1xuaW1wb3J0IHtcbiAgQWJzdHJhY3RFbGVtZW50XG59IGZyb20gXCJzcGluYWwtbW9kZWxzLWJ1aWxkaW5nLWVsZW1lbnRzXCI7XG5cbi8vIGltcG9ydCBiaW1vYmpTZXJ2aWNlIGZyb20gJ3NwaW5hbC1lbnYtdmlld2VyLXBsdWdpbi1iaW1vYmplY3RzZXJ2aWNlJztcblxuY29uc3QgYmltb2JqU2VydmljZSA9IHdpbmRvdy5zcGluYWwuQmltT2JqZWN0U2VydmljZTtcblxuaW1wb3J0ICogYXMgY29uc3RhbnRzIGZyb20gXCIuL2NvbnN0YW50c1wiO1xuaW1wb3J0IHtcbiAgTW9kZWxcbn0gZnJvbSBcInNwaW5hbC1jb3JlLWNvbm5lY3RvcmpzX3R5cGVcIjtcblxuY29uc3QgR2VvZ3JhcGhpY0NvbnRleHQgPSB7XG4gIGNvbnN0YW50czogY29uc3RhbnRzLFxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBjaGlsZCB0eXBlIG9mIHRoZSB0eXBlIGdpdmVuIGFzIHBhcmFtZXRlci5cbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhcmVudFR5cGVcbiAgICogQHJldHVybiB7c3RyaW5nfSBDaGlsZCB0eXBlXG4gICAqL1xuICBnZXRDaGlsZFR5cGUocGFyZW50VHlwZSkge1xuICAgIGxldCBwYXJlbnRUeXBlSW5kZXggPSBjb25zdGFudHMuR0VPR1JBUEhJQ19UWVBFU19PUkRFUi5pbmRleE9mKFxuICAgICAgcGFyZW50VHlwZSk7XG5cbiAgICBpZiAocGFyZW50VHlwZUluZGV4ID09PSAtMSkge1xuICAgICAgcmV0dXJuIFwiXCI7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbnN0YW50cy5HRU9HUkFQSElDX1RZUEVTX09SREVSW3BhcmVudFR5cGVJbmRleCArIDFdO1xuICB9LFxuXG4gIC8qKlxuICAgKiBJdCBUYWtlcyBhcyBwYXJhbWV0ZXIgYSBjb250ZXh0IG5hbWUsIHJldHVybnMgdHJ1ZSBpZiBhIGNvbnRleHQgd2l0aCB0aGUgc2FtZSBuYW1lIGRvZXMgbm90IGV4aXN0LCBlbHNlIHJldHVybnMgZmFsc2UuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb250ZXh0TmFtZVxuICAgKiBAcmV0dXJucyB7Qm9vbGVhbn1cbiAgICovXG4gIGNyZWF0ZUNvbnRleHQoY29udGV4dE5hbWUpIHtcbiAgICBpZiAodHlwZW9mIGNvbnRleHROYW1lICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgXCJjb250ZXh0TmFtZSBtdXN0IGJlIGEgc3RyaW5nXCIpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbnRleHQgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0Q29udGV4dChjb250ZXh0TmFtZSk7XG5cbiAgICBpZiAodHlwZW9mIGNvbnRleHQgIT09IFwidW5kZWZpbmVkXCIpIHJldHVybiBQcm9taXNlLnJlc29sdmUoY29udGV4dCk7XG5cblxuICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ29udGV4dChjb250ZXh0TmFtZSxcbiAgICAgIGNvbnN0YW50cy5DT05URVhUX1RZUEUsXG4gICAgICBuZXcgQWJzdHJhY3RFbGVtZW50KGNvbnRleHROYW1lKSk7XG5cblxuICB9LFxuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCB0YWtlcyBhcyBwYXJhbWV0ZXJzIGEgY29udGV4dCAoU3BpbmFsQ29udGV4dCksIGEgcGFyZW50IG5vZGUgKG11c3QgYmUgYSBTcGluYWxOb2RlKSBhbmQgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBhYnN0cmFjdCBlbGVtZW50IHR5cGU7XG4gICAqIEBwYXJhbSB7U3BpbmFsQ29udGV4dH0gY29udGV4dCAtIFRoZSBDb250ZXh0IGdlb2dyYXBoaWNcbiAgICogQHBhcmFtIHtTcGluYWxOb2RlfSBub2RlIC0gVGhlIHBhcmVudCBOb2RlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBlbGVtZW50TmFtZSAtIFRoZSBBYnN0YWN0RWxlbWVudCBOYW1lXG4gICAqIEByZXR1cm5zIHtCb29sZWFufVxuICAgKi9cbiAgYWRkQWJzdHJhY3RFbGVtZW50KGNvbnRleHQsIG5vZGUsIGVsZW1lbnROYW1lKSB7XG4gICAgY29uc3QgcGFyZW50VHlwZSA9IG5vZGUudHlwZS5nZXQoKTtcbiAgICBjb25zdCBjaGlsZFR5cGUgPSB0aGlzLmdldENoaWxkVHlwZShwYXJlbnRUeXBlKTtcblxuICAgIGlmICghY2hpbGRUeXBlKSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgYCR7cGFyZW50VHlwZX0gaXMgbm90IGEgdmFsaWQgdHlwZSBpbiBnZW9ncmFwaGljIGNvbnRleHRgXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGNoaWxkUmVsYXRpb24gPSBjb25zdGFudHMuTUFQX1RZUEVfUkVMQVRJT04uZ2V0KGNoaWxkVHlwZSk7XG5cbiAgICBjb25zdCBjaGlsZE5vZGUgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICAgIG5hbWU6IGVsZW1lbnROYW1lLFxuICAgICAgICB0eXBlOiBjaGlsZFR5cGVcbiAgICAgIH0sXG4gICAgICBuZXcgQWJzdHJhY3RFbGVtZW50KGVsZW1lbnROYW1lKVxuICAgICk7XG4gICAgU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkSW5Db250ZXh0KG5vZGUuaWQuZ2V0KCksIGNoaWxkTm9kZSwgY29udGV4dC5pZFxuICAgICAgLmdldCgpLCBjaGlsZFJlbGF0aW9uLCBTUElOQUxfUkVMQVRJT05fVFlQRSk7XG5cbiAgICB0aGlzLmFkZFRvUmVmZXJlbmNlQ29udGV4dChjaGlsZE5vZGUpO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH0sXG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb250ZXh0SWQgLSBUaGUgQ29udGV4dCBnZW9ncmFwaGljIElkXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXJlbnRJZCAtIFRoZSBwYXJlbnQgTm9kZSBJZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gYnVpbGRpbmdOYW1lIC0gQnVpbGRpbmcgTmFtZVxuICAgKi9cbiAgYWRkQnVpbGRpbmcoY29udGV4dElkLCBwYXJlbnRJZCwgYnVpbGRpbmdOYW1lKSB7XG5cbiAgICBsZXQgbm9kZUlkID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmNyZWF0ZU5vZGUoe1xuICAgICAgbmFtZTogYnVpbGRpbmdOYW1lLFxuICAgICAgdHlwZTogY29uc3RhbnRzLkJVSUxESU5HX1RZUEVcbiAgICB9LCBuZXcgQWJzdHJhY3RFbGVtZW50KGJ1aWxkaW5nTmFtZSkpO1xuXG4gICAgdGhpcy5hZGRUb1JlZmVyZW5jZUNvbnRleHQobm9kZUlkKTtcblxuXG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZEluQ29udGV4dChwYXJlbnRJZCwgbm9kZUlkLCBjb250ZXh0SWQsXG4gICAgICBjb25zdGFudHMuQlVJTERJTkdfUkVMQVRJT04sIFNQSU5BTF9SRUxBVElPTl9UWVBFKVxuXG4gIH0sXG5cblxuXG5cblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbnRleHRJZCAtIFRoZSBDb250ZXh0IGdlb2dyYXBoaWMgSWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhcmVudElkIC0gVGhlIHBhcmVudCBOb2RlIElkXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBmbG9vck5hbWUgLSB0aGUgZmxvb3IgTmFtZVxuICAgKi9cbiAgYWRkRmxvb3IoY29udGV4dElkLCBwYXJlbnRJZCwgZmxvb3JOYW1lKSB7XG5cbiAgICBsZXQgbm9kZUlkID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmNyZWF0ZU5vZGUoe1xuICAgICAgbmFtZTogZmxvb3JOYW1lLFxuICAgICAgdHlwZTogY29uc3RhbnRzLkZMT09SX1RZUEVcbiAgICB9LCBuZXcgQWJzdHJhY3RFbGVtZW50KGZsb29yTmFtZSkpO1xuXG4gICAgdGhpcy5hZGRUb1JlZmVyZW5jZUNvbnRleHQobm9kZUlkKTtcblxuICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGRJbkNvbnRleHQocGFyZW50SWQsIG5vZGVJZCwgY29udGV4dElkLFxuICAgICAgY29uc3RhbnRzLkZMT09SX1JFTEFUSU9OLCBTUElOQUxfUkVMQVRJT05fVFlQRSlcblxuICB9LFxuXG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb250ZXh0SWQgLSBUaGUgQ29udGV4dCBnZW9ncmFwaGljIElkXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXJlbnRJZCAtIFRoZSBwYXJlbnQgTm9kZSBJZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gc2l0ZU5hbWUgLSB0aGUgc2l0ZSBOYW1lXG4gICAqL1xuICBhZGRTaXRlKGNvbnRleHRJZCwgcGFyZW50SWQsIHNpdGVOYW1lKSB7XG5cbiAgICBsZXQgbm9kZUlkID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmNyZWF0ZU5vZGUoe1xuICAgICAgbmFtZTogc2l0ZU5hbWUsXG4gICAgICB0eXBlOiBjb25zdGFudHMuU0lURV9UWVBFXG4gICAgfSwgbmV3IEFic3RyYWN0RWxlbWVudChzaXRlTmFtZSkpO1xuXG4gICAgdGhpcy5hZGRUb1JlZmVyZW5jZUNvbnRleHQobm9kZUlkKTtcblxuICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGRJbkNvbnRleHQocGFyZW50SWQsIG5vZGVJZCwgY29udGV4dElkLFxuICAgICAgY29uc3RhbnRzLlNJVEVfUkVMQVRJT04sIFNQSU5BTF9SRUxBVElPTl9UWVBFKVxuXG4gIH0sXG5cblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbnRleHRJZCAtIFRoZSBDb250ZXh0IGdlb2dyYXBoaWMgSWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhcmVudElkIC0gVGhlIHBhcmVudCBOb2RlIElkXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB6b25lTmFtZSAtIFpvbmUgbmFtZVxuICAgKi9cbiAgYWRkWm9uZShjb250ZXh0SWQsIHBhcmVudElkLCB6b25lTmFtZSkge1xuICAgIGxldCBub2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICBuYW1lOiB6b25lTmFtZSxcbiAgICAgIHR5cGU6IGNvbnN0YW50cy5aT05FX1RZUEVcbiAgICB9LCBuZXcgQWJzdHJhY3RFbGVtZW50KHpvbmVOYW1lKSk7XG5cbiAgICB0aGlzLmFkZFRvUmVmZXJlbmNlQ29udGV4dChub2RlSWQpO1xuXG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZEluQ29udGV4dChwYXJlbnRJZCwgbm9kZUlkLCBjb250ZXh0SWQsXG4gICAgICBjb25zdGFudHMuWk9ORV9SRUxBVElPTiwgU1BJTkFMX1JFTEFUSU9OX1RZUEUpO1xuXG4gIH0sXG5cblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbnRleHRJZCAtIFRoZSBDb250ZXh0IGdlb2dyYXBoaWNcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhcmVudElkIC0gVGhlIHBhcmVudCBOb2RlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSByb29tTmFtZSAtIFJvb20gTmFtZVxuICAgKi9cbiAgYWRkUm9vbShjb250ZXh0SWQsIHBhcmVudElkLCByb29tTmFtZSkge1xuICAgIGxldCBub2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICBuYW1lOiByb29tTmFtZSxcbiAgICAgIHR5cGU6IGNvbnN0YW50cy5ST09NX1RZUEVcbiAgICB9LCBuZXcgQWJzdHJhY3RFbGVtZW50KHJvb21OYW1lKSk7XG5cbiAgICB0aGlzLmFkZFRvUmVmZXJlbmNlQ29udGV4dChub2RlSWQpO1xuXG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZEluQ29udGV4dChwYXJlbnRJZCwgbm9kZUlkLCBjb250ZXh0SWQsXG4gICAgICBjb25zdGFudHMuUk9PTV9SRUxBVElPTiwgU1BJTkFMX1JFTEFUSU9OX1RZUEUpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBpdCB1c2VzIGJpbU9iamVjdCBzZXJ2aWNlIHRvIGFkZCBhbGwgZGJJZHMgcGFzc2VkIGFzIHBhcmFtZXRlcnMuXG4gICAqIHRoZSBwYXJhbWV0ZXIgZGJJZHMgY2FuIGJlIGEgc2ltcGxlIGRiSWRzIG9yIGEgbGlzdCBvZiBkYklkcy5cbiAgICogQHBhcmFtIHtTcGluYWxDb250ZXh0fSBjb250ZXh0IC0gVGhlIENvbnRleHQgZ2VvZ3JhcGhpY1xuICAgKiBAcGFyYW0ge1NwaW5hbE5vZGV9IG5vZGUgLSBUaGUgcGFyZW50IE5vZGVcbiAgICogQHBhcmFtIHtOdW1iZXIgfCBBcnJheTxOdW1iZXI+fSBkYklkcyAtIENhbiBiZVxuICAgKi9cbiAgYWRkQmltRWxlbWVudChjb250ZXh0LCBub2RlLCBkYklkcywgbW9kZWwpIHtcblxuICAgIGlmICghQXJyYXkuaXNBcnJheShkYklkcykpIGRiSWRzID0gW2RiSWRzXTtcblxuXG4gICAgLy8gbGUgYmltT2JqZWN0U2VydmljZVxuICAgIC8vIGxldCBjID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldFJlYWxOb2RlKGNvbnRleHQuaWQuZ2V0KCkpO1xuICAgIC8vIGxldCBuID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldFJlYWxOb2RlKG5vZGUuaWQuZ2V0KCkpO1xuXG4gICAgbGV0IGNvbnRleHRJZCA9IGNvbnRleHQuaWQuZ2V0KCk7XG4gICAgbGV0IHBhcmVudElkID0gbm9kZS5pZC5nZXQoKTtcblxuICAgIGRiSWRzLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICAvLyBiaW1vYmpTZXJ2aWNlLmFkZEJJTU9iamVjdChjLCBuLCBlbGVtZW50LmRiSWQsIGVsZW1lbnQubmFtZSk7XG4gICAgICB3aW5kb3cuc3BpbmFsLkJpbU9iamVjdFNlcnZpY2UuYWRkQklNT2JqZWN0KGNvbnRleHRJZCwgcGFyZW50SWQsXG4gICAgICAgIGVsZW1lbnQuZGJJZCxcbiAgICAgICAgZWxlbWVudC5uYW1lLCBtb2RlbClcbiAgICB9KTtcbiAgfSxcblxuXG4gIF9nZXRSZWZlcmVuY2VDb250ZXh0TmFtZShub2RlSWQpIHtcbiAgICBsZXQgbm9kZSA9IFNwaW5hbEdyYXBoU2VydmljZS5nZXRJbmZvKG5vZGVJZCk7XG5cbiAgICBzd2l0Y2ggKG5vZGUudHlwZS5nZXQoKSkge1xuICAgICAgY2FzZSBjb25zdGFudHMuU0lURV9UWVBFOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IGNvbnN0YW50cy5TSVRFX1JFRkVSRU5DRV9DT05URVhULFxuICAgICAgICAgICAgcmVsYXRpb246IGNvbnN0YW50cy5TSVRFX1JFTEFUSU9OXG4gICAgICAgIH07XG4gICAgICBjYXNlIGNvbnN0YW50cy5CVUlMRElOR19UWVBFOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IGNvbnN0YW50cy5CVUlMRElOR19SRUZFUkVOQ0VfQ09OVEVYVCxcbiAgICAgICAgICAgIHJlbGF0aW9uOiBjb25zdGFudHMuQlVJTERJTkdfUkVMQVRJT05cbiAgICAgICAgfTtcblxuICAgICAgY2FzZSBjb25zdGFudHMuRkxPT1JfVFlQRTpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiBjb25zdGFudHMuRkxPT1JfUkVGRVJFTkNFX0NPTlRFWFQsXG4gICAgICAgICAgICByZWxhdGlvbjogY29uc3RhbnRzLkZMT09SX1JFTEFUSU9OXG4gICAgICAgIH07XG5cbiAgICAgIGNhc2UgY29uc3RhbnRzLlpPTkVfVFlQRTpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiBjb25zdGFudHMuWk9ORV9SRUZFUkVOQ0VfQ09OVEVYVCxcbiAgICAgICAgICAgIHJlbGF0aW9uOiBjb25zdGFudHMuWk9ORV9SRUxBVElPTlxuICAgICAgICB9O1xuXG4gICAgICBjYXNlIGNvbnN0YW50cy5ST09NX1RZUEU6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogY29uc3RhbnRzLlJPT01fUkVGRVJFTkNFX0NPTlRFWFQsXG4gICAgICAgICAgICByZWxhdGlvbjogY29uc3RhbnRzLlJPT01fUkVMQVRJT05cbiAgICAgICAgfTtcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH0sXG5cbiAgLyoqXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBub2RlSWRcbiAgICovXG4gIGFkZFRvUmVmZXJlbmNlQ29udGV4dChub2RlSWQpIHtcbiAgICBsZXQgb2JqID0gdGhpcy5fZ2V0UmVmZXJlbmNlQ29udGV4dE5hbWUobm9kZUlkKTtcblxuICAgIGlmICh0eXBlb2Ygb2JqICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBsZXQgY29udGV4dCA9IFNwaW5hbEdyYXBoU2VydmljZS5nZXRDb250ZXh0KG9iai5uYW1lKTtcblxuICAgICAgaWYgKHR5cGVvZiBjb250ZXh0ICE9PSBcInVuZGVmaW5lZFwiKSB7XG5cbiAgICAgICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZChjb250ZXh0LmluZm8uaWQuZ2V0KCksIG5vZGVJZCxcbiAgICAgICAgICBvYmoucmVsYXRpb24sXG4gICAgICAgICAgU1BJTkFMX1JFTEFUSU9OX0xTVF9QVFJfVFlQRSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ29udGV4dChvYmoubmFtZSwgb2JqLm5hbWUucmVwbGFjZShcbiAgICAgICAgXCIuXCIsIFwiXCIpLCBuZXcgTW9kZWwoe1xuICAgICAgICBuYW1lOiBvYmoubmFtZVxuICAgICAgfSkpLnRoZW4oYyA9PiB7XG4gICAgICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGQoYy5pbmZvLmlkLmdldCgpLCBub2RlSWQsXG4gICAgICAgICAgb2JqLnJlbGF0aW9uLFxuICAgICAgICAgIFNQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEUpO1xuICAgICAgfSk7XG5cblxuICAgIH1cblxuICB9LFxuXG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY29udGV4dElkXG4gICAqL1xuICBhZGRDb250ZXh0VG9SZWZlcmVuY2UoY29udGV4dElkKSB7XG4gICAgbGV0IGNvbnRleHQgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0UmVhbE5vZGUoY29udGV4dElkKTtcblxuICAgIGlmICh0eXBlb2YgY29udGV4dCAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgcmV0dXJuIGNvbnRleHQuZm9yRWFjaChjb25zdGFudHMuR0VPR1JBUEhJQ19SRUxBVElPTlMsIChub2RlKSA9PiB7XG4gICAgICAgIFNwaW5hbEdyYXBoU2VydmljZS5fYWRkTm9kZShub2RlKTtcbiAgICAgICAgdGhpcy5hZGRUb1JlZmVyZW5jZUNvbnRleHQobm9kZS5pbmZvLmlkLmdldCgpKTtcbiAgICAgIH0pXG4gICAgfVxuXG4gIH1cblxufTtcblxuZXhwb3J0IGRlZmF1bHQgR2VvZ3JhcGhpY0NvbnRleHQ7XG4iXX0=