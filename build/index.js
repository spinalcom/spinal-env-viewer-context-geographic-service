"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _spinalEnvViewerGraphService = require("spinal-env-viewer-graph-service");

var _spinalModelsBuildingElements = require("spinal-models-building-elements");

var _constants = require("./constants");

var constants = _interopRequireWildcard(_constants);

var _spinalCoreConnectorjs_type = require("spinal-core-connectorjs_type");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

// import bimobjService from 'spinal-env-viewer-plugin-bimobjectservice';

const bimobjService = window.spinal.BimObjectService;

const GeographicContext = {
  constants: constants,

  /**
   * Returns the child type of the type given as parameter.
   * @param {string} parentType
   * @return {string} Child type
   */
  getChildType(parentType) {
    let parentTypeIndex = constants.GEOGRAPHIC_TYPES_ORDER.indexOf(parentType);

    if (parentTypeIndex === -1) {
      return "";
    }

    return constants.GEOGRAPHIC_TYPES_ORDER[parentTypeIndex + 1];
  },

  /**
   * It Takes as parameter a context name, returns true if a context with the same name does not exist, else returns false.
   * @param {string} contextName
   * @returns {Boolean}
   */
  createContext(contextName) {
    if (typeof contextName !== "string") {
      throw Error("contextName must be a string");
    }

    const context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(contextName);

    if (typeof context !== "undefined") return Promise.resolve(context);

    return _spinalEnvViewerGraphService.SpinalGraphService.addContext(contextName, constants.CONTEXT_TYPE, new _spinalModelsBuildingElements.AbstractElement(contextName));
  },

  /**
   * This method takes as parameters a context (SpinalContext), a parent node (must be a SpinalNode) and a string representing the abstract element type;
   * @param {SpinalContext} context - The Context geographic
   * @param {SpinalNode} node - The parent Node
   * @param {string} elementName - The AbstactElement Name
   * @returns {Boolean}
   */
  addAbstractElement(context, node, elementName) {
    const parentType = node.type.get();
    const childType = this.getChildType(parentType);

    if (!childType) {
      throw Error(`${parentType} is not a valid type in geographic context`);
    }

    const childRelation = constants.MAP_TYPE_RELATION.get(childType);

    const childNode = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: elementName,
      type: childType
    }, new _spinalModelsBuildingElements.AbstractElement(elementName));
    _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(node.id.get(), childNode, context.id.get(), childRelation, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);

    this.addToReferenceContext(childNode);

    return true;
  },

  /**
   * @param {string} contextId - The Context geographic Id
   * @param {string} parentId - The parent Node Id
   * @param {string} buildingName - Building Name
   */
  addBuilding(contextId, parentId, buildingName) {

    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: buildingName,
      type: constants.BUILDING_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(buildingName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.BUILDING_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
  },

  /**
   * @param {string} contextId - The Context geographic Id
   * @param {string} parentId - The parent Node Id
   * @param {string} floorName - the floor Name
   */
  addFloor(contextId, parentId, floorName) {

    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: floorName,
      type: constants.FLOOR_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(floorName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.FLOOR_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
  },

  /**
   * @param {string} contextId - The Context geographic Id
   * @param {string} parentId - The parent Node Id
   * @param {string} siteName - the site Name
   */
  addSite(contextId, parentId, siteName) {

    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: siteName,
      type: constants.SITE_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(siteName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.SITE_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
  },

  /**
   * @param {string} contextId - The Context geographic Id
   * @param {string} parentId - The parent Node Id
   * @param {string} zoneName - Zone name
   */
  addZone(contextId, parentId, zoneName) {
    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: zoneName,
      type: constants.ZONE_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(zoneName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.ZONE_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
  },

  /**
   * @param {string} contextId - The Context geographic
   * @param {string} parentId - The parent Node
   * @param {string} roomName - Room Name
   */
  addRoom(contextId, parentId, roomName) {
    let nodeId = _spinalEnvViewerGraphService.SpinalGraphService.createNode({
      name: roomName,
      type: constants.ROOM_TYPE
    }, new _spinalModelsBuildingElements.AbstractElement(roomName));

    this.addToReferenceContext(nodeId);

    return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parentId, nodeId, contextId, constants.ROOM_RELATION, _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE);
  },

  /**
   * it uses bimObject service to add all dbIds passed as parameters.
   * the parameter dbIds can be a simple dbIds or a list of dbIds.
   * @param {SpinalContext} context - The Context geographic
   * @param {SpinalNode} node - The parent Node
   * @param {Number | Array<Number>} dbIds - Can be
   */
  addBimElement(context, node, dbIds, model) {

    if (!Array.isArray(dbIds)) dbIds = [dbIds];

    // le bimObjectService
    // let c = SpinalGraphService.getRealNode(context.id.get());
    // let n = SpinalGraphService.getRealNode(node.id.get());

    let contextId = context.id.get();
    let parentId = node.id.get();

    dbIds.forEach(element => {
      // bimobjService.addBIMObject(c, n, element.dbId, element.name);
      window.spinal.BimObjectService.addBIMObject(contextId, parentId, element.dbId, element.name, model);
    });
  },

  _getReferenceContextName(nodeId) {
    let node = _spinalEnvViewerGraphService.SpinalGraphService.getInfo(nodeId);

    switch (node.type.get()) {
      case constants.SITE_TYPE:
        return {
          name: constants.SITE_REFERENCE_CONTEXT,
          relation: constants.SITE_RELATION
        };
      case constants.BUILDING_TYPE:
        return {
          name: constants.BUILDING_REFERENCE_CONTEXT,
          relation: constants.BUILDING_RELATION
        };

      case constants.FLOOR_TYPE:
        return {
          name: constants.FLOOR_REFERENCE_CONTEXT,
          relation: constants.FLOOR_RELATION
        };

      case constants.ZONE_TYPE:
        return {
          name: constants.ZONE_REFERENCE_CONTEXT,
          relation: constants.ZONE_RELATION
        };

      case constants.ROOM_TYPE:
        return {
          name: constants.ROOM_REFERENCE_CONTEXT,
          relation: constants.ROOM_RELATION
        };

      default:
        return undefined;
    }
  },

  /**
   *
   * @param {string} nodeId
   */
  addToReferenceContext(nodeId) {
    let obj = this._getReferenceContextName(nodeId);

    if (typeof obj !== "undefined") {
      let context = _spinalEnvViewerGraphService.SpinalGraphService.getContext(obj.name);

      if (typeof context !== "undefined") {

        return _spinalEnvViewerGraphService.SpinalGraphService.addChild(context.info.id.get(), nodeId, obj.relation, _spinalEnvViewerGraphService.SPINAL_RELATION_LST_PTR_TYPE);
      }

      return _spinalEnvViewerGraphService.SpinalGraphService.addContext(obj.name, obj.name.replace(".", ""), new _spinalCoreConnectorjs_type.Model({
        name: obj.name
      })).then(c => {
        return _spinalEnvViewerGraphService.SpinalGraphService.addChild(c.info.id.get(), nodeId, obj.relation, _spinalEnvViewerGraphService.SPINAL_RELATION_LST_PTR_TYPE);
      });
    }
  },

  /**
   *
   * @param {string} contextId
   */
  addContextToReference(contextId) {
    let context = _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(contextId);

    if (typeof context !== "undefined") {
      return context.forEach(constants.GEOGRAPHIC_RELATIONS, node => {
        _spinalEnvViewerGraphService.SpinalGraphService._addNode(node);
        this.addToReferenceContext(node.info.id.get());
      });
    }
  }

};

exports.default = GeographicContext;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJjb25zdGFudHMiLCJiaW1vYmpTZXJ2aWNlIiwid2luZG93Iiwic3BpbmFsIiwiQmltT2JqZWN0U2VydmljZSIsIkdlb2dyYXBoaWNDb250ZXh0IiwiZ2V0Q2hpbGRUeXBlIiwicGFyZW50VHlwZSIsInBhcmVudFR5cGVJbmRleCIsIkdFT0dSQVBISUNfVFlQRVNfT1JERVIiLCJpbmRleE9mIiwiY3JlYXRlQ29udGV4dCIsImNvbnRleHROYW1lIiwiRXJyb3IiLCJjb250ZXh0IiwiU3BpbmFsR3JhcGhTZXJ2aWNlIiwiZ2V0Q29udGV4dCIsIlByb21pc2UiLCJyZXNvbHZlIiwiYWRkQ29udGV4dCIsIkNPTlRFWFRfVFlQRSIsIkFic3RyYWN0RWxlbWVudCIsImFkZEFic3RyYWN0RWxlbWVudCIsIm5vZGUiLCJlbGVtZW50TmFtZSIsInR5cGUiLCJnZXQiLCJjaGlsZFR5cGUiLCJjaGlsZFJlbGF0aW9uIiwiTUFQX1RZUEVfUkVMQVRJT04iLCJjaGlsZE5vZGUiLCJjcmVhdGVOb2RlIiwibmFtZSIsImFkZENoaWxkSW5Db250ZXh0IiwiaWQiLCJTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFIiwiYWRkVG9SZWZlcmVuY2VDb250ZXh0IiwiYWRkQnVpbGRpbmciLCJjb250ZXh0SWQiLCJwYXJlbnRJZCIsImJ1aWxkaW5nTmFtZSIsIm5vZGVJZCIsIkJVSUxESU5HX1RZUEUiLCJCVUlMRElOR19SRUxBVElPTiIsImFkZEZsb29yIiwiZmxvb3JOYW1lIiwiRkxPT1JfVFlQRSIsIkZMT09SX1JFTEFUSU9OIiwiYWRkU2l0ZSIsInNpdGVOYW1lIiwiU0lURV9UWVBFIiwiU0lURV9SRUxBVElPTiIsImFkZFpvbmUiLCJ6b25lTmFtZSIsIlpPTkVfVFlQRSIsIlpPTkVfUkVMQVRJT04iLCJhZGRSb29tIiwicm9vbU5hbWUiLCJST09NX1RZUEUiLCJST09NX1JFTEFUSU9OIiwiYWRkQmltRWxlbWVudCIsImRiSWRzIiwibW9kZWwiLCJBcnJheSIsImlzQXJyYXkiLCJmb3JFYWNoIiwiZWxlbWVudCIsImFkZEJJTU9iamVjdCIsImRiSWQiLCJfZ2V0UmVmZXJlbmNlQ29udGV4dE5hbWUiLCJnZXRJbmZvIiwiU0lURV9SRUZFUkVOQ0VfQ09OVEVYVCIsInJlbGF0aW9uIiwiQlVJTERJTkdfUkVGRVJFTkNFX0NPTlRFWFQiLCJGTE9PUl9SRUZFUkVOQ0VfQ09OVEVYVCIsIlpPTkVfUkVGRVJFTkNFX0NPTlRFWFQiLCJST09NX1JFRkVSRU5DRV9DT05URVhUIiwidW5kZWZpbmVkIiwib2JqIiwiYWRkQ2hpbGQiLCJpbmZvIiwiU1BJTkFMX1JFTEFUSU9OX0xTVF9QVFJfVFlQRSIsInJlcGxhY2UiLCJNb2RlbCIsInRoZW4iLCJjIiwiYWRkQ29udGV4dFRvUmVmZXJlbmNlIiwiZ2V0UmVhbE5vZGUiLCJHRU9HUkFQSElDX1JFTEFUSU9OUyIsIl9hZGROb2RlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7QUFLQTs7QUFRQTs7SUFBWUEsUzs7QUFDWjs7OztBQUxBOztBQUVBLE1BQU1DLGdCQUFnQkMsT0FBT0MsTUFBUCxDQUFjQyxnQkFBcEM7O0FBT0EsTUFBTUMsb0JBQW9CO0FBQ3hCTCxhQUFXQSxTQURhOztBQUd4Qjs7Ozs7QUFLQU0sZUFBYUMsVUFBYixFQUF5QjtBQUN2QixRQUFJQyxrQkFBa0JSLFVBQVVTLHNCQUFWLENBQWlDQyxPQUFqQyxDQUNwQkgsVUFEb0IsQ0FBdEI7O0FBR0EsUUFBSUMsb0JBQW9CLENBQUMsQ0FBekIsRUFBNEI7QUFDMUIsYUFBTyxFQUFQO0FBQ0Q7O0FBRUQsV0FBT1IsVUFBVVMsc0JBQVYsQ0FBaUNELGtCQUFrQixDQUFuRCxDQUFQO0FBQ0QsR0FqQnVCOztBQW1CeEI7Ozs7O0FBS0FHLGdCQUFjQyxXQUFkLEVBQTJCO0FBQ3pCLFFBQUksT0FBT0EsV0FBUCxLQUF1QixRQUEzQixFQUFxQztBQUNuQyxZQUFNQyxNQUNKLDhCQURJLENBQU47QUFFRDs7QUFFRCxVQUFNQyxVQUFVQyxn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QUFPQSxRQUFRbUQsT0FBUixDQUFnQmpFLFVBQVV3RixvQkFBMUIsRUFBaURqRSxJQUFELElBQVU7QUFDL0RSLHdEQUFtQjBFLFFBQW5CLENBQTRCbEUsSUFBNUI7QUFDQSxhQUFLYSxxQkFBTCxDQUEyQmIsS0FBS3lELElBQUwsQ0FBVTlDLEVBQVYsQ0FBYVIsR0FBYixFQUEzQjtBQUNELE9BSE0sQ0FBUDtBQUlEO0FBRUY7O0FBOVJ1QixDQUExQjs7a0JBa1NlckIsaUIiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFLFxuICBTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFLFxuICBTcGluYWxHcmFwaFNlcnZpY2Vcbn0gZnJvbSBcInNwaW5hbC1lbnYtdmlld2VyLWdyYXBoLXNlcnZpY2VcIjtcbmltcG9ydCB7XG4gIEFic3RyYWN0RWxlbWVudFxufSBmcm9tIFwic3BpbmFsLW1vZGVscy1idWlsZGluZy1lbGVtZW50c1wiO1xuXG4vLyBpbXBvcnQgYmltb2JqU2VydmljZSBmcm9tICdzcGluYWwtZW52LXZpZXdlci1wbHVnaW4tYmltb2JqZWN0c2VydmljZSc7XG5cbmNvbnN0IGJpbW9ialNlcnZpY2UgPSB3aW5kb3cuc3BpbmFsLkJpbU9iamVjdFNlcnZpY2U7XG5cbmltcG9ydCAqIGFzIGNvbnN0YW50cyBmcm9tIFwiLi9jb25zdGFudHNcIjtcbmltcG9ydCB7XG4gIE1vZGVsXG59IGZyb20gXCJzcGluYWwtY29yZS1jb25uZWN0b3Jqc190eXBlXCI7XG5cbmNvbnN0IEdlb2dyYXBoaWNDb250ZXh0ID0ge1xuICBjb25zdGFudHM6IGNvbnN0YW50cyxcblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgY2hpbGQgdHlwZSBvZiB0aGUgdHlwZSBnaXZlbiBhcyBwYXJhbWV0ZXIuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXJlbnRUeXBlXG4gICAqIEByZXR1cm4ge3N0cmluZ30gQ2hpbGQgdHlwZVxuICAgKi9cbiAgZ2V0Q2hpbGRUeXBlKHBhcmVudFR5cGUpIHtcbiAgICBsZXQgcGFyZW50VHlwZUluZGV4ID0gY29uc3RhbnRzLkdFT0dSQVBISUNfVFlQRVNfT1JERVIuaW5kZXhPZihcbiAgICAgIHBhcmVudFR5cGUpO1xuXG4gICAgaWYgKHBhcmVudFR5cGVJbmRleCA9PT0gLTEpIHtcbiAgICAgIHJldHVybiBcIlwiO1xuICAgIH1cblxuICAgIHJldHVybiBjb25zdGFudHMuR0VPR1JBUEhJQ19UWVBFU19PUkRFUltwYXJlbnRUeXBlSW5kZXggKyAxXTtcbiAgfSxcblxuICAvKipcbiAgICogSXQgVGFrZXMgYXMgcGFyYW1ldGVyIGEgY29udGV4dCBuYW1lLCByZXR1cm5zIHRydWUgaWYgYSBjb250ZXh0IHdpdGggdGhlIHNhbWUgbmFtZSBkb2VzIG5vdCBleGlzdCwgZWxzZSByZXR1cm5zIGZhbHNlLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY29udGV4dE5hbWVcbiAgICogQHJldHVybnMge0Jvb2xlYW59XG4gICAqL1xuICBjcmVhdGVDb250ZXh0KGNvbnRleHROYW1lKSB7XG4gICAgaWYgKHR5cGVvZiBjb250ZXh0TmFtZSAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgIFwiY29udGV4dE5hbWUgbXVzdCBiZSBhIHN0cmluZ1wiKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb250ZXh0ID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldENvbnRleHQoY29udGV4dE5hbWUpO1xuXG4gICAgaWYgKHR5cGVvZiBjb250ZXh0ICE9PSBcInVuZGVmaW5lZFwiKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNvbnRleHQpO1xuXG5cbiAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENvbnRleHQoY29udGV4dE5hbWUsXG4gICAgICBjb25zdGFudHMuQ09OVEVYVF9UWVBFLFxuICAgICAgbmV3IEFic3RyYWN0RWxlbWVudChjb250ZXh0TmFtZSkpO1xuXG5cbiAgfSxcblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgdGFrZXMgYXMgcGFyYW1ldGVycyBhIGNvbnRleHQgKFNwaW5hbENvbnRleHQpLCBhIHBhcmVudCBub2RlIChtdXN0IGJlIGEgU3BpbmFsTm9kZSkgYW5kIGEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgYWJzdHJhY3QgZWxlbWVudCB0eXBlO1xuICAgKiBAcGFyYW0ge1NwaW5hbENvbnRleHR9IGNvbnRleHQgLSBUaGUgQ29udGV4dCBnZW9ncmFwaGljXG4gICAqIEBwYXJhbSB7U3BpbmFsTm9kZX0gbm9kZSAtIFRoZSBwYXJlbnQgTm9kZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gZWxlbWVudE5hbWUgLSBUaGUgQWJzdGFjdEVsZW1lbnQgTmFtZVxuICAgKiBAcmV0dXJucyB7Qm9vbGVhbn1cbiAgICovXG4gIGFkZEFic3RyYWN0RWxlbWVudChjb250ZXh0LCBub2RlLCBlbGVtZW50TmFtZSkge1xuICAgIGNvbnN0IHBhcmVudFR5cGUgPSBub2RlLnR5cGUuZ2V0KCk7XG4gICAgY29uc3QgY2hpbGRUeXBlID0gdGhpcy5nZXRDaGlsZFR5cGUocGFyZW50VHlwZSk7XG5cbiAgICBpZiAoIWNoaWxkVHlwZSkge1xuICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgIGAke3BhcmVudFR5cGV9IGlzIG5vdCBhIHZhbGlkIHR5cGUgaW4gZ2VvZ3JhcGhpYyBjb250ZXh0YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBjaGlsZFJlbGF0aW9uID0gY29uc3RhbnRzLk1BUF9UWVBFX1JFTEFUSU9OLmdldChjaGlsZFR5cGUpO1xuXG4gICAgY29uc3QgY2hpbGROb2RlID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmNyZWF0ZU5vZGUoe1xuICAgICAgICBuYW1lOiBlbGVtZW50TmFtZSxcbiAgICAgICAgdHlwZTogY2hpbGRUeXBlXG4gICAgICB9LFxuICAgICAgbmV3IEFic3RyYWN0RWxlbWVudChlbGVtZW50TmFtZSlcbiAgICApO1xuICAgIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZEluQ29udGV4dChub2RlLmlkLmdldCgpLCBjaGlsZE5vZGUsIGNvbnRleHQuaWRcbiAgICAgIC5nZXQoKSwgY2hpbGRSZWxhdGlvbiwgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSk7XG5cbiAgICB0aGlzLmFkZFRvUmVmZXJlbmNlQ29udGV4dChjaGlsZE5vZGUpO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH0sXG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb250ZXh0SWQgLSBUaGUgQ29udGV4dCBnZW9ncmFwaGljIElkXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXJlbnRJZCAtIFRoZSBwYXJlbnQgTm9kZSBJZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gYnVpbGRpbmdOYW1lIC0gQnVpbGRpbmcgTmFtZVxuICAgKi9cbiAgYWRkQnVpbGRpbmcoY29udGV4dElkLCBwYXJlbnRJZCwgYnVpbGRpbmdOYW1lKSB7XG5cbiAgICBsZXQgbm9kZUlkID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmNyZWF0ZU5vZGUoe1xuICAgICAgbmFtZTogYnVpbGRpbmdOYW1lLFxuICAgICAgdHlwZTogY29uc3RhbnRzLkJVSUxESU5HX1RZUEVcbiAgICB9LCBuZXcgQWJzdHJhY3RFbGVtZW50KGJ1aWxkaW5nTmFtZSkpO1xuXG4gICAgdGhpcy5hZGRUb1JlZmVyZW5jZUNvbnRleHQobm9kZUlkKTtcblxuXG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZEluQ29udGV4dChwYXJlbnRJZCwgbm9kZUlkLCBjb250ZXh0SWQsXG4gICAgICBjb25zdGFudHMuQlVJTERJTkdfUkVMQVRJT04sIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUpXG5cbiAgfSxcblxuXG5cblxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY29udGV4dElkIC0gVGhlIENvbnRleHQgZ2VvZ3JhcGhpYyBJZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGFyZW50SWQgLSBUaGUgcGFyZW50IE5vZGUgSWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IGZsb29yTmFtZSAtIHRoZSBmbG9vciBOYW1lXG4gICAqL1xuICBhZGRGbG9vcihjb250ZXh0SWQsIHBhcmVudElkLCBmbG9vck5hbWUpIHtcblxuICAgIGxldCBub2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICBuYW1lOiBmbG9vck5hbWUsXG4gICAgICB0eXBlOiBjb25zdGFudHMuRkxPT1JfVFlQRVxuICAgIH0sIG5ldyBBYnN0cmFjdEVsZW1lbnQoZmxvb3JOYW1lKSk7XG5cbiAgICB0aGlzLmFkZFRvUmVmZXJlbmNlQ29udGV4dChub2RlSWQpO1xuXG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZEluQ29udGV4dChwYXJlbnRJZCwgbm9kZUlkLCBjb250ZXh0SWQsXG4gICAgICBjb25zdGFudHMuRkxPT1JfUkVMQVRJT04sIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUpXG5cbiAgfSxcblxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY29udGV4dElkIC0gVGhlIENvbnRleHQgZ2VvZ3JhcGhpYyBJZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGFyZW50SWQgLSBUaGUgcGFyZW50IE5vZGUgSWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNpdGVOYW1lIC0gdGhlIHNpdGUgTmFtZVxuICAgKi9cbiAgYWRkU2l0ZShjb250ZXh0SWQsIHBhcmVudElkLCBzaXRlTmFtZSkge1xuXG4gICAgbGV0IG5vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgIG5hbWU6IHNpdGVOYW1lLFxuICAgICAgdHlwZTogY29uc3RhbnRzLlNJVEVfVFlQRVxuICAgIH0sIG5ldyBBYnN0cmFjdEVsZW1lbnQoc2l0ZU5hbWUpKTtcblxuICAgIHRoaXMuYWRkVG9SZWZlcmVuY2VDb250ZXh0KG5vZGVJZCk7XG5cbiAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkSW5Db250ZXh0KHBhcmVudElkLCBub2RlSWQsIGNvbnRleHRJZCxcbiAgICAgIGNvbnN0YW50cy5TSVRFX1JFTEFUSU9OLCBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFKVxuXG4gIH0sXG5cblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbnRleHRJZCAtIFRoZSBDb250ZXh0IGdlb2dyYXBoaWMgSWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhcmVudElkIC0gVGhlIHBhcmVudCBOb2RlIElkXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB6b25lTmFtZSAtIFpvbmUgbmFtZVxuICAgKi9cbiAgYWRkWm9uZShjb250ZXh0SWQsIHBhcmVudElkLCB6b25lTmFtZSkge1xuICAgIGxldCBub2RlSWQgPSBTcGluYWxHcmFwaFNlcnZpY2UuY3JlYXRlTm9kZSh7XG4gICAgICBuYW1lOiB6b25lTmFtZSxcbiAgICAgIHR5cGU6IGNvbnN0YW50cy5aT05FX1RZUEVcbiAgICB9LCBuZXcgQWJzdHJhY3RFbGVtZW50KHpvbmVOYW1lKSk7XG5cbiAgICB0aGlzLmFkZFRvUmVmZXJlbmNlQ29udGV4dChub2RlSWQpO1xuXG4gICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZEluQ29udGV4dChwYXJlbnRJZCwgbm9kZUlkLCBjb250ZXh0SWQsXG4gICAgICBjb25zdGFudHMuWk9ORV9SRUxBVElPTiwgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSk7XG5cbiAgfSxcblxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY29udGV4dElkIC0gVGhlIENvbnRleHQgZ2VvZ3JhcGhpY1xuICAgKiBAcGFyYW0ge3N0cmluZ30gcGFyZW50SWQgLSBUaGUgcGFyZW50IE5vZGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHJvb21OYW1lIC0gUm9vbSBOYW1lXG4gICAqL1xuICBhZGRSb29tKGNvbnRleHRJZCwgcGFyZW50SWQsIHJvb21OYW1lKSB7XG4gICAgbGV0IG5vZGVJZCA9IFNwaW5hbEdyYXBoU2VydmljZS5jcmVhdGVOb2RlKHtcbiAgICAgIG5hbWU6IHJvb21OYW1lLFxuICAgICAgdHlwZTogY29uc3RhbnRzLlJPT01fVFlQRVxuICAgIH0sIG5ldyBBYnN0cmFjdEVsZW1lbnQocm9vbU5hbWUpKTtcblxuICAgIHRoaXMuYWRkVG9SZWZlcmVuY2VDb250ZXh0KG5vZGVJZCk7XG5cbiAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkSW5Db250ZXh0KHBhcmVudElkLCBub2RlSWQsIGNvbnRleHRJZCxcbiAgICAgIGNvbnN0YW50cy5ST09NX1JFTEFUSU9OLCBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFKTtcbiAgfSxcblxuICAvKipcbiAgICogaXQgdXNlcyBiaW1PYmplY3Qgc2VydmljZSB0byBhZGQgYWxsIGRiSWRzIHBhc3NlZCBhcyBwYXJhbWV0ZXJzLlxuICAgKiB0aGUgcGFyYW1ldGVyIGRiSWRzIGNhbiBiZSBhIHNpbXBsZSBkYklkcyBvciBhIGxpc3Qgb2YgZGJJZHMuXG4gICAqIEBwYXJhbSB7U3BpbmFsQ29udGV4dH0gY29udGV4dCAtIFRoZSBDb250ZXh0IGdlb2dyYXBoaWNcbiAgICogQHBhcmFtIHtTcGluYWxOb2RlfSBub2RlIC0gVGhlIHBhcmVudCBOb2RlXG4gICAqIEBwYXJhbSB7TnVtYmVyIHwgQXJyYXk8TnVtYmVyPn0gZGJJZHMgLSBDYW4gYmVcbiAgICovXG4gIGFkZEJpbUVsZW1lbnQoY29udGV4dCwgbm9kZSwgZGJJZHMsIG1vZGVsKSB7XG5cbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZGJJZHMpKSBkYklkcyA9IFtkYklkc107XG5cblxuICAgIC8vIGxlIGJpbU9iamVjdFNlcnZpY2VcbiAgICAvLyBsZXQgYyA9IFNwaW5hbEdyYXBoU2VydmljZS5nZXRSZWFsTm9kZShjb250ZXh0LmlkLmdldCgpKTtcbiAgICAvLyBsZXQgbiA9IFNwaW5hbEdyYXBoU2VydmljZS5nZXRSZWFsTm9kZShub2RlLmlkLmdldCgpKTtcblxuICAgIGxldCBjb250ZXh0SWQgPSBjb250ZXh0LmlkLmdldCgpO1xuICAgIGxldCBwYXJlbnRJZCA9IG5vZGUuaWQuZ2V0KCk7XG5cbiAgICBkYklkcy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgLy8gYmltb2JqU2VydmljZS5hZGRCSU1PYmplY3QoYywgbiwgZWxlbWVudC5kYklkLCBlbGVtZW50Lm5hbWUpO1xuICAgICAgd2luZG93LnNwaW5hbC5CaW1PYmplY3RTZXJ2aWNlLmFkZEJJTU9iamVjdChjb250ZXh0SWQsIHBhcmVudElkLFxuICAgICAgICBlbGVtZW50LmRiSWQsXG4gICAgICAgIGVsZW1lbnQubmFtZSwgbW9kZWwpXG4gICAgfSk7XG4gIH0sXG5cblxuICBfZ2V0UmVmZXJlbmNlQ29udGV4dE5hbWUobm9kZUlkKSB7XG4gICAgbGV0IG5vZGUgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0SW5mbyhub2RlSWQpO1xuXG4gICAgc3dpdGNoIChub2RlLnR5cGUuZ2V0KCkpIHtcbiAgICAgIGNhc2UgY29uc3RhbnRzLlNJVEVfVFlQRTpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiBjb25zdGFudHMuU0lURV9SRUZFUkVOQ0VfQ09OVEVYVCxcbiAgICAgICAgICAgIHJlbGF0aW9uOiBjb25zdGFudHMuU0lURV9SRUxBVElPTlxuICAgICAgICB9O1xuICAgICAgY2FzZSBjb25zdGFudHMuQlVJTERJTkdfVFlQRTpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiBjb25zdGFudHMuQlVJTERJTkdfUkVGRVJFTkNFX0NPTlRFWFQsXG4gICAgICAgICAgICByZWxhdGlvbjogY29uc3RhbnRzLkJVSUxESU5HX1JFTEFUSU9OXG4gICAgICAgIH07XG5cbiAgICAgIGNhc2UgY29uc3RhbnRzLkZMT09SX1RZUEU6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogY29uc3RhbnRzLkZMT09SX1JFRkVSRU5DRV9DT05URVhULFxuICAgICAgICAgICAgcmVsYXRpb246IGNvbnN0YW50cy5GTE9PUl9SRUxBVElPTlxuICAgICAgICB9O1xuXG4gICAgICBjYXNlIGNvbnN0YW50cy5aT05FX1RZUEU6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogY29uc3RhbnRzLlpPTkVfUkVGRVJFTkNFX0NPTlRFWFQsXG4gICAgICAgICAgICByZWxhdGlvbjogY29uc3RhbnRzLlpPTkVfUkVMQVRJT05cbiAgICAgICAgfTtcblxuICAgICAgY2FzZSBjb25zdGFudHMuUk9PTV9UWVBFOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IGNvbnN0YW50cy5ST09NX1JFRkVSRU5DRV9DT05URVhULFxuICAgICAgICAgICAgcmVsYXRpb246IGNvbnN0YW50cy5ST09NX1JFTEFUSU9OXG4gICAgICAgIH07XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9LFxuXG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gbm9kZUlkXG4gICAqL1xuICBhZGRUb1JlZmVyZW5jZUNvbnRleHQobm9kZUlkKSB7XG4gICAgbGV0IG9iaiA9IHRoaXMuX2dldFJlZmVyZW5jZUNvbnRleHROYW1lKG5vZGVJZCk7XG5cbiAgICBpZiAodHlwZW9mIG9iaiAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgbGV0IGNvbnRleHQgPSBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0Q29udGV4dChvYmoubmFtZSk7XG5cbiAgICAgIGlmICh0eXBlb2YgY29udGV4dCAhPT0gXCJ1bmRlZmluZWRcIikge1xuXG4gICAgICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuYWRkQ2hpbGQoY29udGV4dC5pbmZvLmlkLmdldCgpLCBub2RlSWQsXG4gICAgICAgICAgb2JqLnJlbGF0aW9uLFxuICAgICAgICAgIFNQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEUpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENvbnRleHQob2JqLm5hbWUsIG9iai5uYW1lLnJlcGxhY2UoXG4gICAgICAgIFwiLlwiLCBcIlwiKSwgbmV3IE1vZGVsKHtcbiAgICAgICAgbmFtZTogb2JqLm5hbWVcbiAgICAgIH0pKS50aGVuKGMgPT4ge1xuICAgICAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkKGMuaW5mby5pZC5nZXQoKSwgbm9kZUlkLFxuICAgICAgICAgIG9iai5yZWxhdGlvbixcbiAgICAgICAgICBTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFKTtcbiAgICAgIH0pO1xuXG5cbiAgICB9XG5cbiAgfSxcblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbnRleHRJZFxuICAgKi9cbiAgYWRkQ29udGV4dFRvUmVmZXJlbmNlKGNvbnRleHRJZCkge1xuICAgIGxldCBjb250ZXh0ID0gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldFJlYWxOb2RlKGNvbnRleHRJZCk7XG5cbiAgICBpZiAodHlwZW9mIGNvbnRleHQgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIHJldHVybiBjb250ZXh0LmZvckVhY2goY29uc3RhbnRzLkdFT0dSQVBISUNfUkVMQVRJT05TLCAobm9kZSkgPT4ge1xuICAgICAgICBTcGluYWxHcmFwaFNlcnZpY2UuX2FkZE5vZGUobm9kZSk7XG4gICAgICAgIHRoaXMuYWRkVG9SZWZlcmVuY2VDb250ZXh0KG5vZGUuaW5mby5pZC5nZXQoKSk7XG4gICAgICB9KVxuICAgIH1cblxuICB9XG5cbn07XG5cbmV4cG9ydCBkZWZhdWx0IEdlb2dyYXBoaWNDb250ZXh0OyJdfQ==